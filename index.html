<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Spreadsheet.js</title>
    <!-- Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"
      rel="stylesheet"
      type="text/css"
    />
    <!-- FontAwesome JS -->
    <script defer src="assets/fontawesome/js/all.js"></script>
    <script defer type="text/javascript" src="Spreadsheet.js"></script>
    <script defer type="text/javascript" src="examples.js"></script>

        <style>
      /* Header styles */
      header {
        background-color: white;

        padding: 20px;
        color: #B25229;
        margin: 0 auto;
        text-align: center;
        width: 100%;
      }

      /* Logo styles */
      .logo {
        max-width: 300px;
        text-align: center;
      }

      .page-wrapper {
        background-color: #EBD8D0;
      }

      .text-center {
        vertical-align: middle;
        padding-top: 10%;
       

      }

      #loading {
        border-style: solid;
        border-color: #B25229;
        margin-bottom: 10%;
      }

       #introText {
        text-align: left;
        color: #B25229;
      }

      .column {
        float: left;
        width: 40%;
        padding: 10px;
        margin: 0 3% 0 3%;
      }
    </style>
 
    <!-- Global CSS -->
    <link
      rel="stylesheet"
      href="assets/plugins/bootstrap/css/bootstrap.min.css"
    />
    <!-- Plugins CSS -->
    <link rel="stylesheet" href="assets/plugins/elegant_font/css/style.css" />
    <!-- Theme CSS -->
    <link id="theme-style" rel="stylesheet" href="assets/css/styles.css" />
  </head>

  <body>
    <header>
      <img src="./assets/images/interceptor.png" alt="Logo" class="logo">
      <h4>| Spreadsheet View</h4>
    </header>
    <!-- GITHUB BUTTON JS -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>


    <script type="module">
    import {MidiParser} from './midi-parser.js'
    // select the INPUT element that will handle
    // the file selection.
    let loading = document.getElementById('loading');
    loading.style.display = "none"
    var result = [];
    var result2 = [];
    let source = document.getElementById('filereader');
    let source2 = document.getElementById('filereader2');

    source.addEventListener("change", showLoading);
    
    function showLoading(e) {
      loading.style.display = "block"
    }


    // provide the File source and a callback function
    MidiParser.parse( source, function(obj){

      console.log(obj);
      
      let changeBPM = [];
      let changeSig = [];
      let elemTrack;
      let metaTrack;
      

      //If there is metatrack, we assume track in index 1 will contain the midi notes. 
      // This code doesn't work for multitrack midi files.
      if (obj.tracks > 1) {
      metaTrack = obj.track[0].event;
      elemTrack = obj.track[1].event;

     
      let metaTicks = 0;

      for (var l in metaTrack){

      metaTicks = metaTicks + metaTrack[l].deltaTime;
        if (metaTrack[l].metaType == 81){
           console.log("addedmeta");
          changeBPM.push([metaTicks,metaTrack[l].data]);
        }

        if (metaTrack[l].metaType == 88){
          changeSig.push([metaTicks,[metaTrack[l].data[0],metaTrack[l].data[1]]]);

        }

      }

      }

      else {
      elemTrack = obj.track[0].event;}
      
      console.log(changeSig);
      console.log(elemTrack);


      let ticks_per_quarter = obj.timeDivision;
      let currentTicks = 0;
      let currentTime = 1;
      let currentBar = 1 ;
      let currentBPM = 144;
      let currentDenom = 4;
      let currentNum = 2;
      let delta;
      let delta_msec;
      let k = 0;


      for(var i in elemTrack) {

        /*if (j < changeBPM.length) {
          if (currentTicks + elemTrack[i].deltaTime >= changeBPM[j][0]){
            currentBPM = (1000000 / changeBPM[j][1]) * 60;
            console.log("changed BPM");
            j = j + 1;
          }

        }

        if (k < changeSig.length) {
          if (currentTicks + elemTrack[i].deltaTime >= changeSig[k][0] ) {
            currentNum = changeSig[k][1][0];
            console.log(currentTicks + ": changed signature to " + currentNum);
            k = k + 1;
          }
        }*/



       
          currentTicks = currentTicks + elemTrack[i].deltaTime;

          
          var bar = 1;

          for(var j=0; j<changeSig.length;j++){
            //if the current tick is beyond the next change of signature, we calculate the bars directly by division
            if(j < changeSig.length - 1){
              if(changeSig[j+1][0]<currentTicks){
                bar = bar + (changeSig[j+1][0] - changeSig[j][0])/(ticks_per_quarter * changeSig[j][1][0]);
              }
              else {
                bar = bar + (currentTicks - changeSig[j][0])/(ticks_per_quarter * changeSig[j][1][0]);
                currentNum = changeSig[j][1][0];
                break;
              }
            }

            else {
              bar = bar + (currentTicks - changeSig[j][0])/(ticks_per_quarter * changeSig[j][1][0]);
              currentNum = changeSig[j][1][0];
              break;
            }
            

          }


          currentBar = Math.floor(bar);

          let cQ = bar - currentBar;

          let currentQuarter = Math.floor((cQ * currentNum) + 1);

          let cT =  (cQ - (currentQuarter - 1) / currentNum) / (1/currentNum);

          let currentTick = Math.floor((cT * ticks_per_quarter));

     
          
          if (elemTrack[i].type == 8) {
          result.push([currentTicks, currentBar + "." + currentQuarter + "." + currentTick ,"NOTE_OFF", elemTrack[i].data[0],elemTrack[i].data[1],1,"",""]);
          }

          if (elemTrack[i].type == 9) {
          result.push([currentTicks, currentBar + "." + currentQuarter + "." + currentTick ,"NOTE_ON", elemTrack[i].data[0],elemTrack[i].data[1],1,"",""]);
          }

       
      }

      

      


      console.log(result);
      for(var row in result){



        if(result[row][2]=="NOTE_ON"){
          result2.push([result[row][0],result[row][1],result[row][3],result[row][4]]);
          
          for (var secRow = parseInt(row) + 1; secRow < result.length; secRow++) {
            // console.log(result[1]);
            if (result[secRow][2]=="NOTE_OFF" && result[secRow][3]==result[row][3]){
              result2[result2.length - 1].push(result[secRow][1]);
              break;
            }
            
          }
        
        }

      }


 

    loading.style.display = "none"
    } );

     MidiParser.parse( source2, function(obj){
      let changeBPM = [];
      let elemTrack;
      let metaTrack;

     
      if (obj.tracks > 1) {
        metaTrack = obj.track[0].event;
        elemTrack = obj.track[1].event;


       
        let metaTicks = 0;

        for (var l in metaTrack){

        metaTicks = metaTicks + metaTrack[l].deltaTime;
          if (metaTrack[l].metaType == 81){
             console.log("addedmeta");
            changeBPM.push([metaTicks,metaTrack[l].data]);
          }


        }
        var row = 0;


        
        for (let j=0;j<changeBPM.length;j++){
          /*console.log("j= " + j);
          console.log("changeBPM= " + changeBPM);
          console.log("changeBPM.length= " + changeBPM.length);
          console.log("changeBPM[j+1]= " + changeBPM[parseInt(j)+1]);*/
          

          if (j < changeBPM.length - 1 && row < result2.length){
            while(result2[row][0]<changeBPM[j+1][0] ){
              result2[row].push(Math.round((1000000 / changeBPM[j][1]) * 60));
              row = row + 1;
              if (row == result2.length) {
                break;
              }
              // console.log("changeBPM[j+1][0]= " + changeBPM[j+1][0]);
              // console.log("result2[row][0]= " + result2[row][0]);
            }
          }
          else {
            while(row < result2.length){
              result2[row].push(Math.round((1000000 / changeBPM[j][1]) * 60));
              
              row = row + 1;
            }
          }
        }

        }

      else {
        console.log("ERROR: midi file contains no track for tempo.");
      }



      console.log(result2);

      const sp = Spreadsheet('#midispreadsheet');
      sp.createSpreadsheet(
  {
    // bar: 'text',
    // message_type: 'text',
    // 'pitch': 'number',
    // 'velocity': 'number',
    // 'recorded_tempo': 'number',
    // Start_Ctrl: 'text',
    // End_Ctrl: 'text',
    
    tickInit: 'text',
    barInit: 'text',
    pitch: 'text',
    'velocity': 'number',
    barEnd: 'text',
    recTempo: 'text',


  },
  {
    data: result2,
  }
);
     } );

    </script> 


    <div class="page-wrapper">
      <!-- ******Header****** -->
      

      <section class="text-center">
        <div id="loading">
          <p>Loading MIDI data, please wait...</p>
        </div>
        <div id="introText">
          <ol>
            <li>Upload a MIDI file</li>
            <li>Edit the spreadsheet</li>
            <li>Download the resulting spreadsheet as a new MIDI file</li>
          </ol>

        </div>
        <div class="container">
          <div class="row">
            <div class="column" style="border-color: #B25229; border-style: solid;">
              
              <h4> Notes </h4>
              
             <input type="file" id="filereader">
            </div>

            <div class="column" style="border-color: #B25229; border-style: solid; ">
              <h4> Recorded Time </h4>
              <input type="file" id="filereader2">
            </div>
          </div>
         
          
          <div class="spreadsheet-example">
            
            <div id="midispreadsheet"></div>
          </div>
          
          <!--//cards-->
        </div>
        <!--//container-->
      </section>
      <!--//cards-section-->
    </div>
    <!--//page-wrapper-->

    
    <!-- Main Javascript -->
    <script
      type="text/javascript"
      src="assets/plugins/jquery-3.4.1.min.js"
    ></script>
    <script
      type="text/javascript"
      src="assets/plugins/bootstrap/js/bootstrap.min.js"
    ></script>
    <script
      type="text/javascript"
      src="assets/plugins/stickyfill/dist/stickyfill.min.js"
    ></script>
    <script type="text/javascript" src="assets/js/main.js"></script>
  </body>
</html>
