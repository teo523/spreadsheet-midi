<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Spreadsheet.js</title>
    <!-- Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"
      rel="stylesheet"
      type="text/css"
    />
    <!-- FontAwesome JS -->
    <script defer src="assets/fontawesome/js/all.js"></script>
    <script defer type="text/javascript" src="Spreadsheet.js"></script>
    <script defer type="text/javascript" src="examples.js"></script>

        <style>
      /* Header styles */
      header {
        background-color: white;

        padding: 20px;
        color: #B25229;
        margin: 0 auto;
        text-align: center;
        width: 100%;
      }

      /* Logo styles */
      .logo {
        max-width: 300px;
        text-align: center;
      }

      .page-wrapper {
        background-color: #EBD8D0;
      }

      .text-center {
        vertical-align: middle;
        padding-top: 10%;
       

      }

      #loading {
        border-style: solid;
        border-color: #B25229;
        margin-bottom: 10%;
      }

       #introText {
        text-align: left;
        color: #B25229;
      }
    </style>
 
    <!-- Global CSS -->
    <link
      rel="stylesheet"
      href="assets/plugins/bootstrap/css/bootstrap.min.css"
    />
    <!-- Plugins CSS -->
    <link rel="stylesheet" href="assets/plugins/elegant_font/css/style.css" />
    <!-- Theme CSS -->
    <link id="theme-style" rel="stylesheet" href="assets/css/styles.css" />
  </head>

  <body>
    <header>
      <img src="./assets/images/interceptor.png" alt="Logo" class="logo">
      <h4>| Spreadsheet View</h4>
    </header>
    <!-- GITHUB BUTTON JS -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>


    <script type="module">
    import {MidiParser} from './midi-parser.js'
    // select the INPUT element that will handle
    // the file selection.
    let loading = document.getElementById('loading');
    loading.style.display = "none"
    var result = [];
    let source = document.getElementById('filereader');

    source.addEventListener("change", showLoading);
    
    function showLoading(e) {
      loading.style.display = "block"
    }
    // provide the File source and a callback function
    MidiParser.parse( source, function(obj){

      console.log(obj);
      
      let changeBPM = [];
      let changeSig = [];
      let elemTrack;
      let metaTrack;
      


      if (obj.tracks > 1) {
      metaTrack = obj.track[0].event;
      elemTrack = obj.track[1].event;

     
      let metaTicks = 0;

      for (var l in metaTrack){

      metaTicks = metaTicks + metaTrack[l].deltaTime;
        if (metaTrack[l].metaType == 81){
           console.log("addedmeta");
          changeBPM.push([metaTicks,metaTrack[l].data]);
        }

        if (metaTrack[l].metaType == 88){
          changeSig.push([metaTicks,[metaTrack[l].data[0],metaTrack[l].data[1]]]);

        }

      }

      }

      else {
      elemTrack = obj.track[0].event;}
      
      console.log(changeSig);

      let ticks_per_quarter = 480;
      let currentTicks = 0;
      let currentBar = 1 ;
      let currentBPM = 120;
      let currentDenom = 4;
      let currentNum = 4;
      let delta;
      let delta_msec;
      let j = 0;
      let k = 0;


      for(var i in elemTrack) {
        if (currentTicks + elemTrack[i] > changeBPM[j][0] & j < changeBPM.length) {
          currentBPM = (1000000 / changeBPM[j][1]) * 60;
          j = j + 1;

        }

        else if (currentTicks + elemTrack[i] > changeSig[k][0] & k < changeSig.length) {
          currentDenom = changeSig[k][1][0];
          k = k + 1;
        }

          let barDelta = Math.round(elemTrack[i].deltaTime / (ticks_per_quarter * currentDenom))

          currentBar = currentBar + barDelta;

          currentTicks = currentTicks + elemTrack[i].deltaTime;
          
          if (elemTrack[i].type == 8) {
          result.push([currentBar,"NOTE_OFF", elemTrack[i].data[0],elemTrack[i].data[1],1,"",""]);
          }

          if (elemTrack[i].type == 9) {
          result.push([currentBar,"NOTE_ON", elemTrack[i].data[0],elemTrack[i].data[1],1,"",""]);
          }

       
      }

      console.log(result);

      var result2 = [];



      for(var row in result){



        if(result[row][1]=="NOTE_ON"){
          result2.push([result[row][0],result[row][2],result[row][3]]);
          
          for (var secRow = parseInt(row) + 1; secRow < result.length; secRow++) {
            // console.log(result[1]);
            if (result[secRow][1]=="NOTE_OFF" && result[secRow][2]==result[row][2]){
              result2[result2.length - 1].push(result[secRow][0]);
            }
            
          }
        
        }

      }


      const sp = Spreadsheet('#midispreadsheet');
      sp.createSpreadsheet(
  {
    // bar: 'text',
    // message_type: 'text',
    // 'pitch': 'number',
    // 'velocity': 'number',
    // 'recorded_tempo': 'number',
    // Start_Ctrl: 'text',
    // End_Ctrl: 'text',
   
    barInit: 'text',
    pitch: 'text',
    'velocity': 'number',
    barEnd: 'text',


  },
  {
    data: result2,
  }
);

    loading.style.display = "none"
    } );



    </script> 


    <div class="page-wrapper">
      <!-- ******Header****** -->
      

      <section class="text-center">
        <div id="loading">
          <p>Loading MIDI data, please wait...</p>
        </div>
        <div id="introText">
          <ol>
            <li>Upload a MIDI file</li>
            <li>Edit the spreadsheet</li>
            <li>Download the resulting spreadsheet as a new MIDI file</li>
          </ol>

        </div>
        <div class="container">

        <input type="file" id="filereader">
         
          
          <div class="spreadsheet-example">
            
            <div id="midispreadsheet"></div>
          </div>
          
          <!--//cards-->
        </div>
        <!--//container-->
      </section>
      <!--//cards-section-->
    </div>
    <!--//page-wrapper-->

    
    <!-- Main Javascript -->
    <script
      type="text/javascript"
      src="assets/plugins/jquery-3.4.1.min.js"
    ></script>
    <script
      type="text/javascript"
      src="assets/plugins/bootstrap/js/bootstrap.min.js"
    ></script>
    <script
      type="text/javascript"
      src="assets/plugins/stickyfill/dist/stickyfill.min.js"
    ></script>
    <script type="text/javascript" src="assets/js/main.js"></script>
  </body>
</html>
